# ym-timeclock
實習打卡系統 

下面我直接給你三份文件草稿，都是 Markdown 格式，你可以拆成：

* `rules.md`（管理規定）
* `manual.md`（使用手冊）
* `Spec.md`（系統規格）

你可以依實際情況調整數字與條文。

---

## 一、管理規定（rules.md）

```markdown
# 出勤與請假管理規定（草案）

> 版本：v1.0  
> 適用對象：所有實習生與兼職同仁  

---

## 1. 制度目的與理念

1. 本制度目標：
   - 協助大家養成 **自律與負責任** 的工作習慣。
   - 提供 **彈性**，讓大家能兼顧學業與實習。
   - 讓管理者能 **公平、具體、有依據** 地處理出勤問題。

2. 核心原則：
   - **提前告知、主動溝通，流程簡化。**
   - **晚告知、事後補救，需提供證明並可能扣分。**
   - **反覆不改善者，依本規則扣分與處置。**
   - **有提出改善方案且實際改善者，可減免或不扣分。**

---

## 2. 定義與名詞說明

1. **上班時間**：  
   - 依個人排班或實習合約載明之當日預定「上班起始時間」與「下班時間」。
   - 例如：10:00–19:00（中午自動扣除 1.5 小時午休）。

2. **遲到**：
   - 第一次「上班打卡事件」時間 ＞ 預定上班時間 + 5 分鐘寬限，即視為遲到。
   - 例如：上班 10:00，10:06 打卡視為遲到。

3. **早退**：
   - 下班前未經同意提前離開，或實際工作時數明顯不足且無正當理由。

4. **缺勤**：
   - 當日排定需上班，**未打卡且未請假**，視為缺勤。
   - **無故缺勤**：未事先告知也未事後說明，或說明內容明顯不實。

5. **請假類型**：
   - 病假（含生理假）
   - 事假
   - 其他（喪假、重大事故、不可抗力…）

6. **出勤型態**：
   - 公司實地實習
   - 遠端實習（WFH）
   - 自主學習（下班或非實習時段）

7. **預先告知（事前通知）**：
   - 同日上班之前，**原則上需於預定上班時間前 30 分鐘前**，用指定管道告知主管：
     - 可能會遲到
     - 當日預計請假（含暫定）
   - 超過此時間，原則上視為「未預先告知」。

> 上述時間點可依團隊實際情況調整，但需事前公告。

---

## 3. 打卡規定

1. **必須打卡的時點**
   - 每日上班開始：上班打卡。
   - 每日上班結束：下班打卡。
   - 中途外出再回來：
     - 外出時：休息開始（中途離開）
     - 回來時：休息結束（恢復上班）
   - 遠端實習 / 自主學習：
     - 開始與結束皆需打卡。

2. **不用打卡的時段**
   - 中午午休時間系統自動扣除 1.5 小時，**無需打卡**。

3. **打卡管道**
   - 個人專屬頁面：`https://timeclock.vdo.tw/<實習生代碼>`
   - Discord Bot 指令（例如 `/in`, `/out`, `/break_start`, `/break_end`）

4. **打卡紀錄異常**
   - 一天只有上班打卡沒有下班打卡，或只有下班打卡沒有上班打卡，視為「異常」紀錄。
   - 異常紀錄需填寫補打卡單並說明原因。

---

## 4. 預先告知與請假原則

1. **預先告知遲到**
   - 在預定上班時間前 30 分鐘，透過指定管道（Discord / Teams / 表單）告知：
     - 預計遲到時間
     - 粗略原因
   - 適用優惠：
     - **不須提供證明**（原則上）。
     - 若為偶發性、且遲到時間合理（如 30 分鐘內），**不扣分**，但仍會紀錄。
   - 若同一人 **預先告知遲到超過 3 次 / 月**，管理者可視情況啟動「輔導與改善計畫」，再發生時可能開始扣分。

2. **預先告知請假**
   - 建議原則：
     - 1 日以內的事假：至少前 1 個工作日告知。
     - 超過 2 日以上的請假：至少前 3 個工作日告知。
   - 預先告知的優點：
     - 主管可提早安排代理人與工作分配。
     - **原則上免附請假證明**（重大長期請假或特殊情況除外）。
   - 若已預先告知，改為未來確定日期，再透過系統正式送出請假單即可。

3. **當日臨時請假 / 晚通報**
   - 未在上述期限內告知者，視為「晚通報」。
   - 除非有明確證明為重大突發事件（如事故、急診），否則：
     - 需填請假單。
     - 原則上需提供相關證明（醫院、政府機關、考試證明…）。
     - 可能依本規定扣分。

---

## 5. 補打卡與證明

1. **可申請補打卡的情況**
   - 已準時到/離開，但 **因操作疏忽未打卡**。
   - 系統或網路異常導致打卡失敗（需說明情況）。

2. **補打卡流程**
   - 透過系統填寫補打卡申請：
     - 補打卡日期與時間。
     - 類型（上班 / 下班 / 遠端 / 自主學習）。
     - 原因說明。
     - 「下次如何避免」改善方案。
   - 如有相關證明，可一併上傳（存入公司指定 Google Drive）。

3. **補打卡原則**
   - 同一人每月 **偶發 1–2 次**，且說明合理有改善方案者，**不扣分，但列入紀錄**。
   - 若補打卡次數過多（例如 **每月 > 3 次**）或理由反覆類似，視為「管理問題」，依扣分標準執行。

---

## 6. 扣分制度與標準（示意，可調整）

> 基本設計：  
> - 每位實習生每月出勤評分基準為 100 分。  
> - 根據下列狀況扣分，合計為當月出勤分數。  
> - 累積扣分影響津貼、獎金、實習證明與續留機會。

### 6.1 一般遲到

- **事前有預先告知**
  - 每月前 3 次、遲到 ≤ 30 分鐘：不扣分，列入紀錄。
  - 同月第 4 次起，每次遲到（≤ 30 分鐘）：**扣 1 分**。
  - 單次遲到 > 30 分鐘：**扣 1–2 分**（由主管視情況決定）。

- **未預先告知或超過時間才告知**
  - 遲到 ≤ 30 分鐘：**扣 1 分**。
  - 遲到 30–60 分鐘：**扣 2 分**。
  - 遲到 > 60 分鐘：**扣 3 分**，並列入「重大異常」，需與主管面談。

> 若當事人提供合理證明 + 提出具體改善方案，且後續 4 週內無再犯，  
> 管理者得視情況調整為減半扣分或撤銷一次扣分。

### 6.2 早退

- 未經同意提前離開，且未事前告知：
  - 視早退時間與影響程度，**扣 1–3 分**。
  - 若有預先與主管協調，且工作已安排妥當，原則上不扣分。

### 6.3 未請假缺勤 / 當日臨時請假

- 當日才告知事假，且無重大突發原因：
  - **扣 2 分**，需提出改善方案。
- 未請假、未打卡、也未說明：視為 **無故缺勤**：
  - **扣 5–10 分**（視情節，重大者可直接終止實習）。

### 6.4 補打卡過多

- 當月補打卡：
  - 第 1–2 次：不扣分，列入紀錄，需填改善方式。
  - 第 3–4 次：每次 **扣 1 分**。
  - 第 5 次起：每次 **扣 2 分**，並列入「嚴重管理問題」。

### 6.5 不實申報 / 濫用彈性

- 蓄意偽造出勤（代打卡、謊稱工作但實際未執行等）：
  - **一次扣 10 分以上**，必要時終止實習。
- 反覆以「預先告知」為由請假或遲到，但實際為可避免情況：
  - 管理者得將其部分事前通知「改視同未預先告知」處理，並依上列標準扣分。

---

## 7. 獎勵機制（正向公平）

1. **準時出勤獎勵**
   - 單月無遲到、無早退、無無故缺勤：  
     - 可加分（例如 +3 分）或記錄於實習證明的正向評價。
2. **主動協助管理**
   - 積極提前告知並配合調整、協助他人了解規則者：
     - 可由主管視情況給予額外加分或口頭表揚。

---

## 8. 評估與處置流程

1. **當月出勤分數**
   - 80 分以上：正常。
   - 70–79 分：需提醒與觀察，必要時安排面談。
   - 60–69 分：列為「出勤待改善對象」，簽署改善計畫。
   - 60 分以下：視情況可能終止實習或不予開立正向實習證明。

2. **改善計畫**
   - 明確記錄：
     - 問題類型
     - 改善措施
     - 觀察期間
   - 若觀察期間內明顯改善，可恢復部分扣分或不再追加扣分。

---

## 9. 公開資訊與隱私

1. 系統首頁（timeclock.vdo.tw）
   - 顯示目前在職實習生基本出勤狀況（例如：出勤天數、遲到次數、請假概況）。
   - 具體呈現方式以鼓勵進步為主，避免過度羞辱。

2. 個人專屬頁面（timeclock.vdo.tw/實習生代碼）
   - 顯示個人詳細出勤紀錄與扣分情況。

> 注意：公開出勤資訊有助透明與公平，但也可能造成壓力與人際影響，  
> 管理者應適度控管公開程度，並以教育與改善為優先。
```

---

## 二、使用手冊（manual.md）

````markdown
# 出勤打卡系統使用手冊（實習生版）

> 版本：v1.0

---

## 1. 系統概觀

本系統提供以下功能：

- 上下班與中途外出打卡
- 請假與補打卡申請
- 自主學習 / 遠端實習打卡
- 個人出勤紀錄與扣分查詢
- 自動更新 Google 行事曆與 Notion 請假看板（經主管核准後）

---

## 2. 登入與個人專屬頁

### 2.1 簡易方式（預設）

- 每位實習生會分配到一個專屬連結，例如：

  ```text
  https://timeclock.vdo.tw/I86
````

* `I86` 為你的實習代碼，對應到你的姓名。
* 點擊該網址即可進入自己的個人出勤頁面。

> 注意：此方式方便但安全性較低，請勿將連結任意轉給非本團隊人員。

### 2.2 進階方式（若啟用）

若之後啟用帳號登入：

1. 使用你的 **Discord 帳號** 或 **Google 帳號** 登入。
2. 登入後系統會綁定你的實習代碼，之後可直接透過登入後畫面打卡。

---

## 3. 日常打卡操作

### 3.1 上班打卡

* 時間到公司 / 開始遠端工作時：

  * 方式一：到個人頁面按「上班打卡」。
  * 方式二：在 Discord 使用 `/in` 指令打卡。

* 成功後畫面會顯示：

  * 打卡時間
  * 出勤類型（實地 / 遠端 / 自主學習）

### 3.2 下班打卡

* 結束當日工作時：

  * 到個人頁面按「下班打卡」，或使用 `/out` 指令。
* 系統會顯示：

  * 今日工時
  * 今日是否遲到
  * 是否有異常（缺打卡、工時不足等）
  * 預估扣分與原因（若有）

### 3.3 中途外出（扣除時數）

* 離開公司且不在工作狀態時：

  * 出門前：按「休息開始」（或 `/break_start`）
  * 回來後：按「休息結束」（或 `/break_end`）
* 系統會依「休息開始」到「休息結束」的時間，扣除實際工作時數。

### 3.4 午休

* 中午 **不用打卡**。
* 系統會自動扣除固定 1.5 小時午休。

---

## 4. 請假流程

### 4.1 預先告知（建議）

1. 確認你可能無法出席的日期與時間。
2. 儘早透過指定管道（Discord/Teams）告知主管：

   * 請假日期與時段
   * 請假原因（簡要）
3. 之後再登入系統，送出正式請假申請。

> 預先告知多半可以 **免附請假證明**，並減少扣分風險。

### 4.2 正式請假申請

1. 到個人頁面，點選「請假」。
2. 填寫：

   * 起始日期與時間
   * 結束日期與時間
   * 請假類型（病假 / 生理假 / 事假 / 其他）
   * 請假原因描述
3. 若有證明（醫院證明、考試通知等），可直接上傳：

   * 系統會自動將檔案存到公司指定的 Google Drive 資料夾。

### 4.3 當日臨時請假

* 若遇到突發狀況（例如生病、家中事故）：

  * 儘速通知主管與團隊。
  * 儘快登入系統填寫請假單並上傳證明（若有）。
* 若非重大突發狀況，且未事前告知，可能依規定扣分。

---

## 5. 補打卡流程

### 5.1 什麼時候需要補打卡？

* 今天有到場 / 有工作，但：

  * 忘記上班打卡或下班打卡。
  * 中途外出沒有按「休息開始 / 結束」。
  * 系統明顯異常（你操作了但沒有紀錄）。

### 5.2 如何補打卡？

1. 到個人頁面 → 點選「補打卡申請」。
2. 填寫：

   * 補打卡日期、時間
   * 類型（上班 / 下班 / 遠端 / 自主學習）
   * 原因說明
   * 「下次如何避免」改善方式（必要欄位）
3. 若有相關證明（截圖、紀錄等），可一併上傳。

> 補打卡偶爾發生可以接受，但過多會被視為管理問題並扣分。

---

## 6. 查看個人出勤與扣分

1. 打開你的個人頁面（例如 `https://timeclock.vdo.tw/I86`）。
2. 可以看到：

   * 每日出勤紀錄（上班時間、下班時間、工時、類型）。
   * 遲到 / 早退 / 請假 / 自主學習紀錄。
   * 當月扣分明細：

     * 遲到幾次、補打卡幾次、是否有未預先告知的情況。
   * 當月總分與狀態說明（正常 / 需改善 / 風險）。

---

## 7. 系統通知與公告

1. **Discord Bot 提醒**

   * 若上班時間已到、你尚未打卡，可能會收到提醒訊息。
   * 有新的請假 / 補打卡審核結果時，也會透過 Discord 通知。

2. **公開看板 / 排行**

   * 系統首頁可能會公開：

     * 出勤優良前幾名
     * 遲到或異常統計（呈現方式依管理策略調整）

> 公開的目的是增加透明度與公平性，並提醒大家注意出勤習慣。
> 若你覺得有誤，請盡快與主管反映。

---

## 8. 常見問題（FAQ）

**Q1：忘記打卡但有確實上班，會被當作缺勤嗎？**
A：不會，但你必須盡快填補打卡申請，說明原因與改善方式。若常常忘記打卡，會依規定扣分。

**Q2：已經預先告知會遲到，還會被扣分嗎？**
A：原則上不會，但系統仍會記錄。若你預先告知遲到的次數非常頻繁，主管可能會找你談改善方式，必要時仍可能扣分。

**Q3：請假一定要附證明嗎？**
A：若你有事前預告，且天數不長，通常不需證明。但當日臨時請假或請假次數過多，主管有權要求證明。

**Q4：我認為扣分不合理，可以申訴嗎？**
A：可以。請先整理實際情況與相關證據，與主管當面討論。系統將依討論結果調整紀錄。

````

---

## 三、系統規格（Spec.md）

```markdown
# TimeClock 出勤系統規格說明（Spec）

> 版本：v1.0  
> 架構：小型後端服務 + Web 後台 + Discord Bot + Google / Notion / Google Drive 整合  
> 後端語言：TypeScript + Node.js  
> DB：PostgreSQL（開發：本機；正式：Supabase / GCP）  
> 前端：Web 後台（React / Next.js 類型）  
> 部署：GCP + Docker（Cloud Run 或 GKE）

---

## 1. 目標與非目標

### 1.1 目標

- 精準紀錄實習生出勤事件（上班、下班、休息、遠端、自主學習）。
- 依管理規則，自動計算：
  - 每日工時
  - 遲到 / 早退 / 補打卡 / 請假統計
  - 扣分與當月出勤分數
- 提供：
  - 公開出勤看板（timeclock.vdo.tw）
  - 個人出勤頁面
  - 管理後台（審核、調整、統計）
- 整合：
  - Discord Bot（打卡、提醒、公告）
  - Google Calendar（請假事件）
  - Notion 看板（請假記錄）
  - Google Drive（上傳請假證明 / 補打卡證明）

### 1.2 非目標

- 不處理薪資計算（只輸出出勤資料供其他系統使用）。
- 不作為正式 HR 系統（僅支援實習與簡單兼職情境）。
- 不支援高度複雜的班表（輪班制等），只針對「固定或簡單排班」。

---

## 2. 系統架構總覽

### 2.1 元件

1. **Backend API**
   - 技術：Node.js + TypeScript（建議使用 NestJS）
   - 功能：
     - REST / GraphQL API
     - 出勤事件寫入與計算
     - 請假 / 補打卡 / 扣分邏輯
     - 對外整合（Google / Notion / Discord）

2. **Database**
   - PostgreSQL
     - 開發：本機 Postgres（Docker）
     - 正式：Supabase 或 GCP Cloud SQL
   - ORM：Prisma

3. **Web 前台 / 後台**
   - 技術：React / Next.js（TypeScript）
   - 模組：
     - 公開首頁（出勤看板）
     - 個人頁面（打卡 + 紀錄）
     - Admin 後台（管理員操作）

4. **Discord Bot**
   - 技術：Node.js + `discord.js`
   - 功能：
     - slash commands：打卡、查詢、請假申請入口
     - 通知：提醒打卡、請假審核結果、每週統計公告

5. **外部整合**
   - Google Calendar API：請假通過後，建立/更新事件。
   - Notion API：同步請假看板（卡片）。
   - Google Drive API：上傳請假與補打卡證明（檔案）。

6. **部署**
   - 開發：
     - Docker Compose：Backend + DB + Admin 前端
   - 正式：
     - Build Docker Image
     - 部署到 GCP Cloud Run（或 GKE）
     - DB 使用 Supabase / Cloud SQL

---

## 3. 使用者角色與權限

1. **實習生 / 一般使用者**
   - 打卡（上班、下班、休息、遠端、自主學習）
   - 申請請假 / 補打卡
   - 上傳證明檔案
   - 查看個人出勤紀錄與扣分

2. **管理員 / 主管**
   - 查看所有實習生出勤紀錄與統計
   - 審核請假 / 補打卡
   - 手動調整紀錄（保留 audit log）
   - 設定班表與實習起訖日期
   - 匯出報表（CSV / Excel）

3. **系統管理者（DevOps / Admin）**
   - 管理服務帳戶與 API 金鑰
   - 管理部署與備份策略
   - 管理系統設定檔（如遲到寬限、扣分規則）

---

## 4. 功能需求（Functional Requirements）

### FR-1 出勤事件紀錄

- 支援事件類型：
  - `WORK_ONSITE_START`, `WORK_ONSITE_END`
  - `WORK_REMOTE_START`, `WORK_REMOTE_END`
  - `SELF_STUDY_START`, `SELF_STUDY_END`
  - `BREAK_OFFSITE_START`, `BREAK_OFFSITE_END`
- 每個事件至少包含：
  - user_id
  - event_type
  - timestamp（伺服器時間）
  - source（web / discord / admin / retro）
  - metadata（如 IP、user agent）

### FR-2 日工時與遲到判定

- 每日計算邏輯：
  - 將當日事件排序，配對 start/end 形成 segments。
  - 計算有效工作時間：
    - 實地 + 遠端 + 自主學習（依規則權重可不同）。
  - 自動扣除午休 1.5 小時。
- 遲到計算：
  - 比對第一個 WORK_START 事件與排班時間。
- 早退判定：
  - 實際工時顯著低於預定工時，且未經同意。

### FR-3 請假管理

- 功能：
  - 實習生送出請假申請（含預告與正式）。
  - 管理員審核（approve / reject）。
  - 審核通過：
    - 寫入 DB
    - 呼叫 Google Calendar 新增/更新事件
    - 呼叫 Notion API 更新請假看板
- 請假類型與規則：
  - 符合管理規定文件（rules.md）所定義。

### FR-4 補打卡管理

- 功能：
  - 實習生送出補打卡申請：
    - 日期、時間、類型、原因、改善方案。
    - 可上傳證明檔案（存 Google Drive）。
  - 管理員審核：
    - 通過：寫入對應的 `AttendanceEvent`（source=retro_approved）。
    - 駁回：紀錄理由，不修改原出勤。
- 系統需支援統計補打卡次數。

### FR-5 扣分與評分引擎

- 將 rules.md 中的規則轉為可配置參數：
  - 遲到時間區間 → 對應扣分。
  - 是否預先告知 → 套用不同條件。
  - 補打卡次數門檻。
- 每日或每次事件變動時更新：
  - 當日狀態
  - 當月出勤扣分與總分
- 需保留扣分明細：
  - 原因、關聯事件、審核人、時間。

### FR-6 公開首頁（timeclock.vdo.tw）

- 顯示目前在職實習生列表：
  - 姓名（或代碼）、目前狀態（上班中 / 下班 / 請假 / 遠端…）
  - 簡易統計（本月出勤天數、遲到次數…）
- 可突出顯示：
  - 出勤優良榜。
  - 遲到或補打卡異常提醒區（呈現方式需注意不過度羞辱）。
- 提供連結至個人頁面。

### FR-7 個人頁面（timeclock.vdo.tw/{code}）

- 功能：
  - 上班 / 下班 / 休息打卡操作。
  - 當日視圖：
    - 當日打卡紀錄與工時。
    - 是否遲到 / 早退。
    - 當日扣分（若有）。
  - 歷史視圖：
    - 可選日期範圍查看出勤與扣分。
  - 請假 / 補打卡入口。
  - 上傳證明檔案入口。

### FR-8 班表與實習期間管理

- 管理員可設定：
  - 實習開始與結束日期。
  - 每位實習生預定上班時間與每週工作日。
- 系統依班表決定：
  - 哪些日期需要出勤。
  - 不排班的日子不計入遲到 / 缺勤。

### FR-9 Discord Bot 功能

- Slash Commands（示意）：
  - `/in` 上班打卡
  - `/out` 下班打卡
  - `/break_start` 休息開始
  - `/break_end` 休息結束
  - `/leave` 開啟請假申請入口（回覆表單網址或互動式表單）
  - `/retro_clock` 補打卡申請入口
  - `/today` 查詢今天出勤狀態
  - `/my_score` 查詢本月出勤分數與扣分明細
- 通知：
  - 上班時間過 N 分鐘未打卡 → 發 DM 提醒。
  - 管理員審核結果 → 通知申請人。
  - 每週統計 → 在指定 Discord 看板頻道發公告。

### FR-10 Google / Notion / Google Drive 整合

- Google Calendar：
  - 使用服務帳戶或專用帳號管理「團隊行事曆」。
  - 請假通過 → 新增/更新事件。
  - 請假取消 → 刪除或標註事件。

- Notion：
  - 一個固定 Database 作為請假看板。
  - 每一筆請假對應一頁或一列，欄位包含：
    - 員工、日期、類型、狀態、連結到系統紀錄。

- Google Drive：
  - 專用資料夾存放證明檔案。
  - 每筆檔案記錄：
    - 所屬 user_id
    - 關聯請假 / 補打卡申請 id
    - Drive file id

---

## 5. 資料模型（概略）

### 5.1 主要資料表（示意）

- `User`
  - id
  - code（如 I86）
  - name
  - email
  - role（intern / admin）
  - is_active
  - discord_id（可選）
  - google_account（可選）

- `InternshipTerm`
  - id
  - user_id
  - start_date
  - end_date
  - base_schedule (JSON：每週何時上班)

- `AttendanceEvent`
  - id
  - user_id
  - type（enum）
  - timestamp
  - source（web / discord / admin / retro）
  - related_request_id（補打卡 / 請假 id）
  - created_at

- `DaySummary`
  - id
  - user_id
  - date
  - total_work_seconds
  - is_late
  - late_minutes
  - is_early_leave
  - is_absent
  - status_notes

- `LeaveRequest`
  - id
  - user_id
  - start_datetime
  - end_datetime
  - type
  - reason
  - status（pending / approved / rejected）
  - approver_id
  - calendar_event_id
  - notion_page_id
  - created_at
  - updated_at

- `RetroClockRequest`
  - id
  - user_id
  - date
  - time
  - type
  - reason
  - improvement_plan
  - status
  - approver_id
  - drive_file_id

- `ScoreRecord`
  - id
  - user_id
  - month
  - base_score
  - total_deduction
  - final_score

- `ScoreDetail`
  - id
  - score_record_id
  - reason_type（late / absence / retro / misconduct）
  - related_date
  - related_event_id
  - points_delta（負值為扣分）
  - notes

---

## 6. API（概略列舉）

> 僅列出主要路由，實作時可再細化。

### 6.1 使用者端 API

- `POST /api/clock/in`
- `POST /api/clock/out`
- `POST /api/clock/break-start`
- `POST /api/clock/break-end`
- `POST /api/leave`
- `POST /api/retro-clock`
- `GET  /api/me/day-summary?date=YYYY-MM-DD`
- `GET  /api/me/month-summary?month=YYYY-MM`

### 6.2 管理端 API

- `GET  /api/admin/users`
- `GET  /api/admin/attendance?user_id=&date_range=`
- `GET  /api/admin/leave-requests?status=pending`
- `POST /api/admin/leave-requests/{id}/approve`
- `POST /api/admin/leave-requests/{id}/reject`
- `GET  /api/admin/retro-requests?status=pending`
- `POST /api/admin/retro-requests/{id}/approve`
- `POST /api/admin/retro-requests/{id}/reject`
- `POST /api/admin/attendance/manual-adjust`
- `GET  /api/admin/scores?month=YYYY-MM`
- `GET  /api/admin/report/export?month=YYYY-MM`

### 6.3 公開 / 半公開 API

- `GET /api/public/board`  
  - 回傳在職實習生的簡單出勤統計給首頁使用。
- `GET /api/public/user/{code}/summary`  
  - 個人頁面資料（需做基本防護，如簡易簽章或限縮資訊）。

---

## 7. 認證與安全性

### 7.1 簡易識別方式（短期）

- 個人頁 URL：`/I86`  
- 風險：
  - URL 若被猜到或外流，可能被他人代為打卡。
- 緩解措施（建議）：
  - 加一層簡單 token（例如 `/u/I86?token=xxx`）並定期更換。
  - 嚴禁共享個人連結，違者依規定處理。

### 7.2 進階登入（中長期建議）

- 支援：
  - Discord OAuth2
  - Google OAuth2
- 流程：
  - 使用者登入 → 授權 → 後端綁定 `user_id`。
- 優點：
  - 無需記密碼、避免代打卡。
- Side effect：
  - 實作成本增加，需要申請與維護 OAuth 憑證。

---

## 8. 非功能性需求（NFR）

- 可用性：
  - 平日上班時間目標可用率 ≥ 99%。
- 效能：
  - 單次打卡 API 延遲目標 < 300ms（不含外部 API）。
- 安全：
  - 所有外部連線需使用 HTTPS。
  - 機敏設定（API Key、Service Account）存於 GCP Secret Manager 或同等機制。
- 備份：
  - DB 每日自動備份。
- 稽核：
  - 所有管理端操作需有 audit log。

---

## 9. 開發與部署流程

1. 開發環境（Mac）
   - 使用 Docker Compose：
     - `backend`（NestJS）
     - `db`（PostgreSQL）
     - `admin-frontend`（Next.js）
   - 使用 Prisma migration 管理 schema。

2. CI/CD
   - push 到 main / release 分支 → 自動 build Docker image。
   - 執行測試通過後 → 部署到 GCP Cloud Run。

3. 正式環境
   - Backend / Bot：
     - Docker image 跑在 Cloud Run。
   - DB：
     - Supabase / Cloud SQL。
   - 靜態前端：
     - 部署於 Cloud Run 或 Cloud Storage + CDN。

---

## 10. 後續可擴充功能（建議）

1. **異常偵測**
   - 自動標記：
     - 只有上班沒下班打卡。
     - 只有下班沒上班打卡。
     - 工時異常過短或過長。

2. **匿名求助 / 反饋**
   - 在系統中保留匿名求助管道，對應你們原本表單的功能。

3. **個人月報表**
   - 一鍵產出 PDF / CSV，提供給實習生自存或附在實習證明。

4. **群組 / 小隊長視圖**
   - 小隊長只看到自己負責的實習生，避免資訊過度公開。

5. **規則配置介面**
   - 管理者可在後台調整：
     - 遲到寬限
     - 每一種違規的扣分點數
     - 預告期限等參數
   - 減少改 code 的頻率。

````

---

如果你要開始實作，下一步可以直接從：

* 把 rules.md & manual.md 放進 Notion/Repo 當「制度文件」
* 在 `Spec.md` 的基礎上先實作：
  **User / AttendanceEvent / DaySummary / LeaveRequest** 這幾張表 + `/in` `/out` `/leave` API + 最簡單的個人頁面

之後需要，我也可以幫你把 Prisma schema 或 NestJS module skeleton 寫出來。





#  初期想法 ：

1. 系統切成幾個模組

後端 API / 計算核心

功能：

接收打卡 / 請假 / 補打卡請求

記錄「事件」(event-based)：上班、下班、休息開始、休息結束、請假單、補打卡申請、審核結果…

根據事件，計算「每天工時、遲到次數、請假統計」

對外提供 REST/GraphQL API 給：

Discord bot

Web 後台（管理頁）

之後如果要再接別的前端也可以（例如簡單 mobile web）

Discord Bot

slash 指令 / button：

/in 上班打卡

/out 下班打卡

/break_start、/break_end 中途外出

/leave 申請請假（簡要資訊 + 自動給 Web 表單連結補充）

/retro_clock 補打卡（遺漏打卡＋說明）

/today 查看自己今天打卡 & 工時計算

/help 出勤規則與流程教學

Bot 主要工作：

把指令轉成 API call

回傳簡短訊息 / embed 給使用者

定期推播公告（例如每週遲到排行榜、請假列表摘要）

Web 後台（管理 + 自助查詢）

管理員視角：

人員列表、出勤紀錄查詢、工時 / 遲到率統計

補打卡 / 請假單審核

匯出 CSV / Excel

一般成員視角：

查看自己某段時間出勤紀錄

查看自己遲到次數、請假紀錄

檢查請假申請狀態（審核中 / 通過 / 駁回）

整合模組（Google Calendar / Notion / Discord 公告）

Leave 或請假單通過時：

呼叫 Google Calendar API 建立 / 更新行事曆事件

呼叫 Notion API 更新請假看板（新增一筆卡片或更新狀態）

定時 Job：

每天 / 每週在 Discord 看板發出統計（遲到率、請假數量…）

排程與提醒模組

Cron Job / scheduler：

上班時間過 X 分鐘還沒打卡 → DM / 提醒

下班時間過 X 分鐘還沒下班打卡 → 提醒

有人送出補打卡 / 請假申請 → 通知管理員審核


# 參考資料  ： 舊版的Google  Forms 打卡  與管理規定
 
------
### **打卡流程整理**

**1. 基本打卡**
- 上下班都須打卡。
- *中午休息時間*不用打卡（系統自動扣除1.5小時）。
- 若中途離開、稍後會回來上班，請分別操作「休息開始」及「休息結束」。
- 若預期會遲到/請假，請提前告知以免部分處罰和證明需求。
- *遲到、未改善，或未經預告臨時請假、請假過多，補打卡過多等行為*會影響獎金及實習證明。
- *津貼*以現場辦公為主，遠距目前無獎金。

**2. 請假和補打卡流程**
- 請假建議提前告知，可免部分證明/處罰。
- 需填寫請假或補打卡單（表單區段2）。
- 若遲到或忘打卡，須補單並說明原因，並提出改進方式（表單區段3）。
- 報告出勤型態（現場、遠端、自主學習），選擇對應類別（表單區段4）。
 
**3. 進度回報**
- 請於Teams回報每日進度和明日規劃，下班前務必完成。
- 有困難或不便直接反映，可用表單描述求助（表單區段5）。

**4. 補打卡詳細操作**
- 選擇補打卡類型（上班、下班、遠端、自主學習）。
- 填寫補打卡日期及時間。
- 說明如何避免下次遺漏。

**5. 請假流程（預告、正式、當日）**
- 預先告知請假後需同步Teams行事曆並標註「暫定」。
- 正式請假需標明開始/結束日期與時間、類型、原因。
    - 生理假/病假：不需證明（但主管得事後要求補證明）。
    - 事假：除突發事故，均須事前申請，超過規定天數須提前預告。
- 當日請假需填寫原因及相關資料。

***
### **表單內容轉為 Markdown 範本**

```markdown
# 2024出勤與請假紀錄（Google 表單）

## 注意事項
- 中午休息時間不用打卡（系統自動扣除1.5小時）
- 養成提前告知習慣
  1. 事假預先提前告知可免除請假證明（不確定時間/天數亦可預先告知）
  2. 預告可能遲到可免除遲到處罰次數
- 遲到未改善、非突發臨時請假、請假太多、未打卡/補打卡次數過多，會影響獎金及實習證明評語

- 交通伙食津貼僅限辦公室實習，遠距目前無獎金

- 詳細請假規則：  
  [Notion 請假規則](https://www.notion.so/ymvdo/608498e5aaee44cf9e8a91cafabe810b?pvs=4)

---

## 打卡種類
- 上班打卡
- 下班打卡
- 休息開始（中途離開辦公室，稍後回來）
- 休息結束（返回辦公室繼續工作）
- 其他（預先告知、請假、遲到、補打卡等）

---

## 請假/補打卡
- 預先告知：當日可能會遲到
- 預先告知：可能會請假
- 正式請假／當日請假補假單
- 準時上班忘打卡，須補打卡
- 當日遲到需補打卡

---

## 遲到區段
- 填寫遲到原因
- 說明如何避免下次再發生

---

## 出勤類別
- 公司實地實習
- 遠端實習（WFH）
- 下班後在家自主學習

---

## 今日進度
- Teams 張貼訊息（不需填表單）
- 下班前回報進度
- 遭遇困難可於表單反映（可匿名）

---

## 補打卡
- 補上班打卡
- 補下班打卡
- 補遠端實習上班打卡
- 補遠端實習下班打卡
- 補自主學習開始
- 補自主學習結束
- 填寫補打卡日期、時間及如何避免忘記打卡

---

## 預先告知請假
- 表單填寫後，更新Teams行事曆並標註「暫定」，確定後再修正

---

## 正式請假
- 填寫起始日期、時間，結束日期、時間
- 請假類型如下：
  - 當日請病假、生理假（不需證明）
  - 當日請事假（重大不可抗拒之變故）
  - 事假(已預告，不需證明)
  - 事假(於規定期限內請假，需檢附證明，公司協助代理人)
  - 事假(未於規定期限內請假，需檢附證明，自行尋找代理人)
  - 其他
- 填寫請假原因

---

## 當日請假
- 填寫請假說明及意見回饋
```

[1](https://docs.google.com/forms/d/1G05tX0L7TfndqSfWcfprH1cm5f0zS2qmmhLo0_-RBx4/edit)


